{% extends 'base.html' %} {% block title %}{{ _('Divisiones Adm1') }}{% endblock
%} {% block content %}
<div class="container-fluid mt-4" style="margin-bottom: 100px">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ _('Divisiones administrativas - Nivel 1') }}</h2>
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#addAdm1Modal"
    >
      <i class="fas fa-plus"></i> {{ _('Agregar') }}
    </button>
  </div>

  <!-- Barra de búsqueda (estática) -->
  <div class="d-flex align-items-center mb-3 gap-3">
    <input
      type="text"
      class="form-control me-2"
      placeholder="{{ _('Buscar...') }}"
      style="max-width: 300px"
      id="adm1-search"
    />
    <div class="dropdown">
      <button 
        class="btn btn-outline-secondary dropdown-toggle" 
        type="button" 
        id="adm1FiltersDropdown" 
        data-bs-toggle="dropdown" 
        data-bs-auto-close="outside"
        aria-expanded="false"
      >
        <i class="fas fa-filter"></i> {{_('Filtros')}}
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adm1FiltersDropdown" style="min-width: 250px;">
        <!-- Se llenará dinámicamente -->
        <li><div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Cargando filtros...</div></li>
      </ul>
    </div>
    <span id="adm1SearchResults" class="text-muted small"></span>
  </div>

  {% if adm1 %}
  <form id="bulk-action-form" method="POST" action="{{ url_for('adm1.bulk_action') }}">
    <div class="mb-2">
      <input type="hidden" name="action" id="bulk-action-hidden" value="" />
      <button type="button" class="btn btn-danger btn-sm" disabled id="bulk-disable">
        <i class="fas fa-trash"></i> {{ _('Deshabilitar seleccionados') }}
      </button>
      <button type="button" class="btn btn-success btn-sm" disabled id="bulk-recover">
        <i class="fas fa-undo"></i> {{ _('Recuperar seleccionados') }}
      </button>
    </div>
  <table class="table table-hover align-middle" id="adm1-table">
    <thead class="table-light">
      <tr>
        <th style="width: 5%"><input type="checkbox" id="select-all" /></th>
        <th>{{ _('Nombre') }}</th>
        <th>{{ _('País') }}</th>
        <th>{{ _('Estado') }}</th>
        <th class="text-end">{{ _('Acciones') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for adm in adm1 %}
      <tr>
        <td><input type="checkbox" name="selected_ids" value="{{ adm.id }}" class="select-row" /></td>
        <td class="searchable-name">{{ adm.name }}</td>
        <td class="searchable-country">{{ adm.country.name }}</td>
        <td class="searchable-state">{{ _('Habilitado') if adm.enable else _('Deshabilitado') }}</td>
        <td class="text-end">
          <a
            href="{{ url_for('adm1.edit_adm1', id=adm.id) }}"
            class="btn btn-warning btn-sm me-2"
            title="{{ _('Editar') }}"
          >
            <i class="fas fa-pen"></i>
          </a>
          {% if adm.enable %}
          <a
            href="{{ url_for('adm1.delete_adm1', id=adm.id) }}"
            class="btn btn-danger btn-sm"
            title="{{ _('Deshabilitar') }}"
          >
            <i class="fas fa-trash"></i>
          </a>
          {% else %}
          <a
            href="{{ url_for('adm1.reset_adm1', id=adm.id) }}"
            class="btn btn-success btn-sm"
            title="{{ _('Recuperar') }}"
          >
            <i class="fas fa-undo"></i>
          </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </form>
  {% else %}
  <div class="alert alert-info mt-4">
    {{ _('No hay divisiones administrativas registradas.') }}
  </div>
  {% endif %}
</div>

<!-- Modal para agregar Adm1 -->
<div
  class="modal fade"
  id="addAdm1Modal"
  tabindex="-1"
  aria-labelledby="addAdm1Label"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <form method="POST" class="modal-content">
      {{ form.hidden_tag() }}
      <div class="modal-header">
        <h5 class="modal-title" id="addAdm1Label">
          {{ _('Agregar división Adm1') }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="{{ _('Cerrar') }}"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          {{ form.name.label(class="form-label") }} {{
          form.name(class="form-control") }} {% for error in form.name.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="mb-3">
          {{ form.country_id.label(class="form-label") }} {{
          form.country_id(class="form-select") }} {% for error in
          form.country_id.errors %}
          <div class="text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="form-check">
          {{ form.enable(class="form-check-input") }} {{
          form.enable.label(class="form-check-label") }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> {{ _('Cancelar') }}
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus"></i> {{ _('Agregar') }}
        </button>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
   // Checkbox select all
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.select-row');
    const bulkDisable = document.getElementById('bulk-disable');
    const bulkRecover = document.getElementById('bulk-recover');
    const form = document.getElementById('bulk-action-form');

    function updateBulkButtons() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      if (anyChecked) {
      bulkDisable.style.visibility = 'visible';
      bulkRecover.style.visibility = 'visible';
      } else {
      bulkDisable.style.visibility = 'hidden';
      bulkRecover.style.visibility = 'hidden';
      }
      bulkDisable.disabled = !anyChecked;
      bulkRecover.disabled = !anyChecked;
    }

    // Inicializar visibilidad al cargar
    updateBulkButtons();

    if (selectAll) {
      selectAll.addEventListener('change', function() {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateBulkButtons();
      });
    }
    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateBulkButtons);
    });

    // Opcional: deshabilitar ambos botones al enviar el form
    form.addEventListener('submit', function() {
      bulkDisable.disabled = true;
      bulkRecover.disabled = true;
    });

    bulkDisable.addEventListener('click', function() {
      document.getElementById('bulk-action-hidden').value = 'disable';
      form.submit();
    });
    bulkRecover.addEventListener('click', function() {
      document.getElementById('bulk-action-hidden').value = 'recover';
      form.submit();
    });

    // --- Filtros tipo dropdown como en users ---
    const searchInput = document.getElementById('adm1-search');
    const table = document.getElementById('adm1-table');
    const filtersDropdown = document.getElementById('adm1FiltersDropdown');
    const filtersMenu = document.querySelector('#adm1FiltersDropdown + .dropdown-menu');
    const searchResults = document.getElementById('adm1SearchResults');
    const rows = table ? table.querySelectorAll('tbody tr') : [];

    let activeCountryFilters = new Set();
    let activeStateFilters = new Set();

    // Obtiene valores únicos de país y estado
    function getUniqueValues(className) {
      const values = new Set();
      rows.forEach(row => {
        const cell = row.querySelector(className);
        if (cell) values.add(cell.textContent.trim());
      });
      return Array.from(values).sort();
    }

    // Genera el menú de filtros
    function generateFiltersMenu() {
      if (!filtersMenu) return;
      const countries = getUniqueValues('.searchable-country');
      const states = getUniqueValues('.searchable-state');

      let menuHTML = `<li><h6 class="dropdown-header">Filtrar por País</h6></li>`;
      countries.forEach(country => {
        const filterId = `filter-country-${country.replace(/\s+/g, '-')}`;
        menuHTML += `
          <li>
            <div class="dropdown-item-text">
              <div class="form-check">
                <input class="form-check-input country-filter" type="checkbox" id="${filterId}" value="${country}">
                <label class="form-check-label" for="${filterId}">
                  ${country}
                </label>
              </div>
            </div>
          </li>
        `;
      });

      menuHTML += `<li><hr class="dropdown-divider"></li>
        <li><h6 class="dropdown-header">Filtrar por Estado</h6></li>`;
      states.forEach(state => {
        const filterId = `filter-state-${state.replace(/\s+/g, '-')}`;
        menuHTML += `
          <li>
            <div class="dropdown-item-text">
              <div class="form-check">
                <input class="form-check-input state-filter" type="checkbox" id="${filterId}" value="${state}">
                <label class="form-check-label" for="${filterId}">
                  ${state}
                </label>
              </div>
            </div>
          </li>
        `;
      });

      menuHTML += `
        <li><hr class="dropdown-divider"></li>
        <li>
          <a class="dropdown-item text-primary" href="#" id="clearAdm1Filters">
            <i class="fas fa-times me-2"></i>Limpiar filtros
          </a>
        </li>
      `;

      filtersMenu.innerHTML = menuHTML;
      initializeFilterEventListeners();
    }

    function initializeFilterEventListeners() {
      document.querySelectorAll('.country-filter').forEach(cb => {
        cb.addEventListener('change', function() {
          if (this.checked) activeCountryFilters.add(this.value);
          else activeCountryFilters.delete(this.value);
          updateFiltersDisplay();
          applyFilters();
        });
      });
      document.querySelectorAll('.state-filter').forEach(cb => {
        cb.addEventListener('change', function() {
          if (this.checked) activeStateFilters.add(this.value);
          else activeStateFilters.delete(this.value);
          updateFiltersDisplay();
          applyFilters();
        });
      });
      const clearBtn = document.getElementById('clearAdm1Filters');
      if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
          e.preventDefault();
          activeCountryFilters.clear();
          activeStateFilters.clear();
          document.querySelectorAll('.country-filter, .state-filter').forEach(cb => cb.checked = false);
          updateFiltersDisplay();
          applyFilters();
        });
      }
    }

    function updateFiltersDisplay() {
      const count = activeCountryFilters.size + activeStateFilters.size;
      if (filtersDropdown) {
        if (count > 0) {
          filtersDropdown.classList.remove("btn-outline-secondary");
          filtersDropdown.classList.add("btn-primary");
          filtersDropdown.innerHTML = `<i class="fas fa-filter me-2"></i>Filtros (${count})`;
        } else {
          filtersDropdown.classList.remove("btn-primary");
          filtersDropdown.classList.add("btn-outline-secondary");
          filtersDropdown.innerHTML = '<i class="fas fa-filter"></i> Filtros';
        }
      }
    }

    // Resaltado de búsqueda
    function clearHighlight(element) {
      if (!element) return;
      element.innerHTML = element.textContent;
    }
    function highlightText(element, searchText) {
      if (!element || !searchText) return;
      const originalText = element.textContent;
      const regex = new RegExp(`(${searchText})`, "gi");
      element.innerHTML = originalText.replace(regex, '<mark>$1</mark>');
    }

    // Aplica búsqueda y filtros
    function applyFilters() {
      const filter = searchInput.value.toLowerCase();
      let visibleCount = 0;
      rows.forEach(row => {
        const nameCell = row.querySelector('.searchable-name');
        const countryCell = row.querySelector('.searchable-country');
        const stateCell = row.querySelector('.searchable-state');
        clearHighlight(nameCell);
        clearHighlight(countryCell);

        let matches = true;
        // Filtro de texto
        if (filter) {
          const rowText = (nameCell?.textContent + ' ' + countryCell?.textContent).toLowerCase();
          matches = matches && rowText.includes(filter);
          if (matches) {
            highlightText(nameCell, filter);
            highlightText(countryCell, filter);
          }
        }
        // Filtro por país
        if (activeCountryFilters.size > 0) {
          matches = matches && activeCountryFilters.has(countryCell?.textContent);
        }
        // Filtro por estado
        if (activeStateFilters.size > 0) {
          matches = matches && activeStateFilters.has(stateCell?.textContent);
        }
        row.style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });
      if (searchResults) {
        if (filter || activeCountryFilters.size > 0 || activeStateFilters.size > 0) {
          searchResults.textContent = `Mostrando ${visibleCount}`;
        } else {
          searchResults.textContent = '';
        }
      }
    }

    // Inicialización
    if (filtersMenu) generateFiltersMenu();
    if (searchInput) searchInput.addEventListener('input', applyFilters);
});    
</script>
{% endblock %}
